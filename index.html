<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tic Tac Toe with AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            /* New background pattern */
            background-color: #111827; /* Tailwind's gray-900 */
            background-image:
                linear-gradient(rgba(255, 255, 255, 0.04) 2px, transparent 2px),
                linear-gradient(90deg, rgba(255, 255, 255, 0.04) 2px, transparent 2px);
            background-size: 100px 100px;
            animation: pan 90s linear infinite;
        }

        @keyframes pan {
            0% { background-position: 0px 0px; }
            100% { background-position: 900px 900px; }
        }

        /* New 3D hover effect for the play button */
        #playButton {
            transition: transform 0.2s ease-out, box-shadow 0.2s ease-out;
            transform-style: preserve-3d;
            box-shadow: 0 8px 15px rgba(0,0,0,0.2);
        }
        #playButton:hover {
            transform: perspective(1000px) rotateX(15deg) rotateY(-15deg) scale3d(1.1, 1.1, 1.1);
            box-shadow: 0 25px 40px rgba(0,0,0,0.4), 0 0 10px rgba(129, 140, 248, 0.6); /* Indigo shadow */
        }

        .cell {
            width: 100px;
            height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out;
        }
        @media (max-width: 640px) {
            .cell {
                width: 80px;
                height: 80px;
                font-size: 2.5rem;
            }
            #board-container {
                width: 252px;
                height: 252px;
            }
        }
        /* Custom styles for X and O to give them distinct colors */
        .text-x { color: #34D399; } /* Emerald-400 */
        .text-o { color: #F87171; } /* Red-400 */

        /* Border styles for the grid */
        .cell:not(:nth-child(3n)) {
            border-right-width: 4px;
        }
        .cell:not(:nth-last-child(-n+3)) {
            border-bottom-width: 4px;
        }
        #line-canvas {
            position: absolute;
            top: 0;
            left: 0;
            pointer-events: none; /* Allows clicks to go through to the board */
        }
    </style>
</head>
<body class="bg-gray-900 text-white flex items-center justify-center min-h-screen">

    <!-- Start Screen -->
    <div id="start-screen" class="text-center">
        <h1 class="text-7xl font-extrabold mb-8 text-white">Tic Tac Toe</h1>
        <button id="playButton" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-4 px-10 rounded-lg text-2xl focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-opacity-50">
            Play
        </button>
    </div>

    <!-- Mode Selection Screen (initially hidden) -->
    <div id="mode-selection-screen" class="hidden text-center">
        <h1 class="text-5xl font-extrabold mb-8 text-white">Choose Game Mode</h1>
        <div class="flex flex-col items-center gap-6">
            <button id="pvpButton" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 px-8 rounded-lg text-xl w-64 transition-transform transform hover:scale-105 shadow-lg">Player vs Player</button>
            <button id="pvaButton" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 px-8 rounded-lg text-xl w-64 transition-transform transform hover:scale-105 shadow-lg">Player vs AI ✨</button>
        </div>
    </div>

    <!-- AI Difficulty Selection Screen (initially hidden) -->
    <div id="difficulty-selection-screen" class="hidden text-center">
        <h1 class="text-5xl font-extrabold mb-8 text-white">Choose AI Difficulty</h1>
        <div class="flex flex-col items-center gap-6">
            <button id="easyButton" data-difficulty="easy" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-8 rounded-lg text-xl w-64 transition-transform transform hover:scale-105 shadow-lg">Easy</button>
            <button id="mediumButton" data-difficulty="medium" class="bg-yellow-500 hover:bg-yellow-600 text-white font-semibold py-3 px-8 rounded-lg text-xl w-64 transition-transform transform hover:scale-105 shadow-lg">Medium</button>
            <button id="hardButton" data-difficulty="hard" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-3 px-8 rounded-lg text-xl w-64 transition-transform transform hover:scale-105 shadow-lg">Hard (Unbeatable)</button>
        </div>
    </div>


    <!-- Game Screen (initially hidden) -->
    <main id="game-screen" class="hidden relative flex flex-col items-center bg-gray-800 p-8 rounded-2xl shadow-2xl">
        <h1 class="text-4xl sm:text-5xl font-bold mb-2">Tic Tac Toe</h1>
        <p id="status" class="text-lg text-gray-400 mb-2 h-8 transition-all duration-300">Player X's turn</p>

        <p id="ai-status" class="text-sm text-yellow-400 mb-2 h-5"></p>

        <!-- Game Board Container -->
        <div id="board-container" class="relative w-[312px] h-[312px] mt-4">
             <div id="board" class="grid grid-cols-3 mx-auto rounded-lg overflow-hidden border-4 border-gray-700 h-full w-full">
                <!-- Cells will be generated by JavaScript -->
            </div>
            <canvas id="line-canvas"></canvas>
        </div>

        <!-- End Game Overlay -->
        <div id="end-game-overlay" class="hidden absolute inset-0 bg-gray-900 bg-opacity-60 backdrop-blur-md flex flex-col items-center justify-center rounded-2xl z-10">
            <h2 id="end-game-message" class="text-6xl font-extrabold text-white animate-pulse">YOU WIN!</h2>
            <div class="mt-8 flex flex-col gap-4 w-64">
                <button id="restartButton" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 px-6 rounded-lg transition-transform transform hover:scale-105 shadow-lg">
                    Restart Game
                </button>
                <button id="mainMenuButton" class="bg-gray-600 hover:bg-gray-700 text-white font-semibold py-3 px-6 rounded-lg transition-transform transform hover:scale-105 shadow-lg">
                    Main Menu
                </button>
            </div>
        </div>
    </main>

    <script>
        const startScreen = document.getElementById('start-screen');
        const modeSelectionScreen = document.getElementById('mode-selection-screen');
        const difficultySelectionScreen = document.getElementById('difficulty-selection-screen');
        const gameScreen = document.getElementById('game-screen');
        const playButton = document.getElementById('playButton');
        const boardElement = document.getElementById('board');
        const statusElement = document.getElementById('status');
        const lineCanvas = document.getElementById('line-canvas');
        const endGameOverlay = document.getElementById('end-game-overlay');
        const endGameMessage = document.getElementById('end-game-message');
        const restartButton = document.getElementById('restartButton');
        const mainMenuButton = document.getElementById('mainMenuButton');
        const pvpButton = document.getElementById('pvpButton');
        const pvaButton = document.getElementById('pvaButton');
        const easyButton = document.getElementById('easyButton');
        const mediumButton = document.getElementById('mediumButton');
        const hardButton = document.getElementById('hardButton');
        const aiStatusElement = document.getElementById('ai-status');
        const canvasCtx = lineCanvas.getContext('2d');

        let currentPlayer = 'X';
        let boardState = ['', '', '', '', '', '', '', '', ''];
        let gameActive = true;
        let gameMode = 'pvp'; // 'pvp' or 'pva'
        let aiDifficulty = 'hard'; // 'easy', 'medium', or 'hard'
        const aiPlayer = 'O';
        const humanPlayer = 'X';

        const winningConditions = [
            [0, 1, 2], [3, 4, 5], [6, 7, 8], // Rows
            [0, 3, 6], [1, 4, 7], [2, 5, 8], // Columns
            [0, 4, 8], [2, 4, 6]             // Diagonals
        ];
        
        // --- Screen Navigation ---
        playButton.addEventListener('click', () => {
            startScreen.classList.add('hidden');
            modeSelectionScreen.classList.remove('hidden');
        });
        
        function startGame() {
            // This now starts the game after mode/difficulty is selected
            gameScreen.classList.remove('hidden');
            restartGame();
        }

        function goToMainMenu() {
            gameScreen.classList.add('hidden');
            endGameOverlay.classList.add('hidden');
            modeSelectionScreen.classList.add('hidden');
            difficultySelectionScreen.classList.add('hidden');
            startScreen.classList.remove('hidden');
        }

        function setCanvasSize() {
            const boardRect = boardElement.getBoundingClientRect();
            lineCanvas.width = boardRect.width;
            lineCanvas.height = boardRect.height;
        }

        function createBoard() {
            boardElement.innerHTML = '';
            for (let i = 0; i < 9; i++) {
                const cell = document.createElement('div');
                cell.classList.add('cell', 'border-gray-700', 'hover:bg-gray-700');
                cell.dataset.index = i;
                cell.addEventListener('click', handleCellClick);
                boardElement.appendChild(cell);
            }
            setTimeout(setCanvasSize, 0);
        }

        // --- Game Logic ---
        function handleCellClick(event) {
            const clickedCell = event.target;
            const clickedCellIndex = parseInt(clickedCell.dataset.index);

            if (boardState[clickedCellIndex] !== '' || !gameActive) return;
            if (gameMode === 'pva' && currentPlayer === aiPlayer) return;

            updateBoard(clickedCell, clickedCellIndex);
            checkResult();
        }

        function updateBoard(cell, index) {
            boardState[index] = currentPlayer;
            cell.textContent = currentPlayer;
            cell.classList.add(currentPlayer === 'X' ? 'text-x' : 'text-o');
        }

        function checkResult() {
            let roundWon = false;
            let winConditionMet = null;

            for (let i = 0; i < winningConditions.length; i++) {
                const winCondition = winningConditions[i];
                let a = boardState[winCondition[0]];
                let b = boardState[winCondition[1]];
                let c = boardState[winCondition[2]];

                if (a === '' || b === '' || c === '') continue;
                if (a === b && b === c) {
                    roundWon = true;
                    winConditionMet = winCondition;
                    break;
                }
            }

            if (roundWon) {
                statusElement.textContent = `Player ${currentPlayer} has won!`;
                gameActive = false;
                drawWinningLine(winConditionMet);
                triggerCelebration();
                showEndScreen(false);
                return;
            }

            if (!boardState.includes('')) {
                statusElement.textContent = 'Game ended in a draw!';
                gameActive = false;
                showEndScreen(true);
                return;
            }

            switchPlayer();

            if (gameMode === 'pva' && currentPlayer === aiPlayer && gameActive) {
                aiStatusElement.textContent = '✨ AI is thinking...';
                setTimeout(() => {
                    const aiMove = getAIMove();
                    const cellToUpdate = boardElement.querySelector(`[data-index='${aiMove}']`);
                    updateBoard(cellToUpdate, aiMove);
                    aiStatusElement.textContent = '';
                    checkResult();
                }, 300); // A small delay to feel more natural
            }
        }
        
        // --- AI Logic Router ---
        function getAIMove() {
            switch(aiDifficulty) {
                case 'easy':
                    return getEasyAIMove(boardState);
                case 'medium':
                    return getMediumAIMove(boardState);
                case 'hard':
                default:
                    return findBestMove(boardState);
            }
        }

        // --- AI Difficulty Levels ---
        function getEasyAIMove(board) {
            let availableSpots = [];
            board.forEach((val, index) => {
                if (val === '') availableSpots.push(index);
            });
            return availableSpots[Math.floor(Math.random() * availableSpots.length)];
        }

        function getMediumAIMove(board) {
            // 1. Check for AI winning move
            for (let i = 0; i < 9; i++) {
                if (board[i] === '') {
                    let tempBoard = [...board];
                    tempBoard[i] = aiPlayer;
                    if (evaluate(tempBoard) === 10) return i;
                }
            }
            // 2. Check for player blocking move
            for (let i = 0; i < 9; i++) {
                if (board[i] === '') {
                    let tempBoard = [...board];
                    tempBoard[i] = humanPlayer;
                    if (evaluate(tempBoard) === -10) return i;
                }
            }
            // 3. Take center
            if (board[4] === '') return 4;
            // 4. Take random corner
            const corners = [0, 2, 6, 8].filter(i => board[i] === '');
            if (corners.length > 0) return corners[Math.floor(Math.random() * corners.length)];
            // 5. Take random side (fallback)
            return getEasyAIMove(board);
        }

        // --- Minimax AI Logic (Hard Difficulty) ---
        function findBestMove(board) {
            let bestVal = -Infinity;
            let bestMove = -1;
            for (let i = 0; i < 9; i++) {
                if (board[i] === '') {
                    board[i] = aiPlayer;
                    let moveVal = minimax(board, 0, false);
                    board[i] = ''; // undo move
                    if (moveVal > bestVal) {
                        bestMove = i;
                        bestVal = moveVal;
                    }
                }
            }
            return bestMove;
        }

        function minimax(board, depth, isMax) {
            let score = evaluate(board);
            if (score === 10) return score - depth;
            if (score === -10) return score + depth;
            if (!board.includes('')) return 0;

            if (isMax) {
                let best = -Infinity;
                for (let i = 0; i < 9; i++) {
                    if (board[i] === '') {
                        board[i] = aiPlayer;
                        best = Math.max(best, minimax(board, depth + 1, !isMax));
                        board[i] = '';
                    }
                }
                return best;
            } else {
                let best = Infinity;
                for (let i = 0; i < 9; i++) {
                    if (board[i] === '') {
                        board[i] = humanPlayer;
                        best = Math.min(best, minimax(board, depth + 1, !isMax));
                        board[i] = '';
                    }
                }
                return best;
            }
        }

        function evaluate(board) {
            for (let i = 0; i < winningConditions.length; i++) {
                const [a, b, c] = winningConditions[i];
                if (board[a] && board[a] === board[b] && board[a] === board[c]) {
                    if (board[a] === aiPlayer) return 10;
                    else if (board[a] === humanPlayer) return -10;
                }
            }
            return 0; // No winner
        }

        // --- UI and State Management ---
        function switchPlayer() {
            currentPlayer = currentPlayer === 'X' ? 'O' : 'X';
            statusElement.textContent = `Player ${currentPlayer}'s turn`;
        }

        function restartGame() {
            gameActive = true;
            currentPlayer = 'X';
            boardState = ['', '', '', '', '', '', '', '', ''];
            statusElement.textContent = `Player ${currentPlayer}'s turn`;
            endGameOverlay.classList.add('hidden');
            aiStatusElement.textContent = '';
            boardElement.style.pointerEvents = 'auto';
            canvasCtx.clearRect(0, 0, lineCanvas.width, lineCanvas.height);
            document.querySelectorAll('.cell').forEach(cell => {
                cell.textContent = '';
                cell.classList.remove('text-x', 'text-o');
            });
        }
        
        function drawWinningLine(winCondition) {
            const cells = boardElement.children;
            const startCell = cells[winCondition[0]];
            const endCell = cells[winCondition[2]];
            
            const startX = startCell.offsetLeft + startCell.offsetWidth / 2;
            const startY = startCell.offsetTop + startCell.offsetHeight / 2;
            const endX = endCell.offsetLeft + endCell.offsetWidth / 2;
            const endY = endCell.offsetTop + endCell.offsetHeight / 2;

            canvasCtx.beginPath();
            canvasCtx.moveTo(startX, startY);
            canvasCtx.lineTo(endX, endY);
            canvasCtx.strokeStyle = '#FFFFFF';
            canvasCtx.lineWidth = 8;
            canvasCtx.lineCap = 'round';
            canvasCtx.stroke();
        }

        function showEndScreen(isDraw) {
            if (isDraw) {
                endGameMessage.textContent = 'DRAW!';
                endGameMessage.classList.remove('text-x', 'text-o');
            } else {
                endGameMessage.textContent = `${currentPlayer} WINS!`;
                endGameMessage.classList.add(currentPlayer === 'X' ? 'text-x' : 'text-o');
            }
            endGameOverlay.classList.remove('hidden');
        }

        function triggerCelebration() {
            confetti({ particleCount: 150, spread: 80, origin: { y: 0.6 }, zIndex: 2000 });
        }

        // --- Event Listeners & Initialization ---
        restartButton.addEventListener('click', restartGame);
        mainMenuButton.addEventListener('click', goToMainMenu);
        window.addEventListener('resize', setCanvasSize);
        
        pvpButton.addEventListener('click', () => {
            gameMode = 'pvp';
            modeSelectionScreen.classList.add('hidden');
            startGame();
        });

        pvaButton.addEventListener('click', () => {
            modeSelectionScreen.classList.add('hidden');
            difficultySelectionScreen.classList.remove('hidden');
        });

        [easyButton, mediumButton, hardButton].forEach(button => {
            button.addEventListener('click', (e) => {
                aiDifficulty = e.target.dataset.difficulty;
                gameMode = 'pva';
                difficultySelectionScreen.classList.add('hidden');
                startGame();
            });
        });

        createBoard();
    </script>
</body>
</html>

