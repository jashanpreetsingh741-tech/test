<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Slide Deck Generator</title>
    <!-- Load Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Inter font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Load Lucide icons -->
    <script src="https://unpkg.com/lucide-react@latest/dist/umd/lucide.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom styles for the slide viewer */
        #slide-viewer {
            /* Creates the slide aspect ratio and centers content */
            aspect-ratio: 16 / 9;
        }
        /* Simple loading spinner */
        .spinner {
            border-top-color: transparent;
            border-style: solid;
            border-width: 4px;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 flex h-screen overflow-hidden">

    <!-- === Sidebar (Controls) === -->
    <div class="w-full max-w-sm lg:w-1/3 bg-white shadow-lg p-6 overflow-y-auto flex flex-col">
        <div class="flex-shrink-0">
            <h1 class="text-2xl font-bold text-blue-600">AI Slide Deck Generator</h1>
            <p class="text-gray-600 mt-2">Enter a topic, and the AI will generate a complete slide deck for you.</p>
        </div>

        <!-- Form for inputs -->
        <form id="prompt-form" class="flex-grow flex flex-col mt-8 space-y-4">
            <div>
                <label for="topic" class="block text-sm font-medium text-gray-700">Topic or Prompt</label>
                <textarea id="topic" rows="4" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 text-base p-3" placeholder="e.g., 'The Future of Renewable Energy' or 'A 10-slide summary of the Roman Republic'"></textarea>
            </div>

            <!-- NEW: File Upload Section -->
            <div>
                <label for="doc-upload" class="block text-sm font-medium text-gray-700">Upload Context (Optional)</label>
                <input type="file" id="doc-upload" accept=".txt,.md" class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 cursor-pointer">
                <p class="mt-1 text-xs text-gray-500">Upload a .txt or .md file to add its content to the topic box.</p>
            </div>
            
            <div>
                <label for="slide-count" class="block text-sm font-medium text-gray-700">Number of Slides</label>
                <input type="number" id="slide-count" value="10" min="3" max="25" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 text-base p-3">
            </div>

            <!-- Generate Button -->
            <div class="pt-4">
                <!-- FIX: Changed type_button="submit" to type="submit" -->
                <button type="submit" id="generate-btn" class="w-full flex justify-center items-center bg-blue-600 text-white p-3 rounded-lg font-semibold hover:bg-blue-700 transition-colors duration-200 disabled:bg-gray-400 disabled:cursor-not-allowed">
                    <span id="btn-text">Generate Presentation</span>
                    <div id="loading-spinner" class="spinner w-5 h-5 border-white hidden ml-2"></div>
                </button>
            </div>
            
            <!-- Error Message Area -->
            <div id="error-message" class="text-red-600 text-sm font-medium hidden p-3 bg-red-50 rounded-lg"></div>
        </form>
    </div>

    <!-- === Main Content (Slide Viewer) === -->
    <div class="w-full lg:w-2/3 p-6 sm:p-10 flex flex-col items-center justify-center">
        <!-- Slide Display Area -->
        <div id="slide-viewer" class="w-full max-w-5xl bg-white shadow-2xl rounded-2xl p-8 sm:p-12 lg:p-16 flex flex-col justify-center items-center text-center relative transition-all duration-300">
            <!-- This content will be dynamically replaced -->
            <div id="empty-state" class="flex flex-col items-center text-gray-500">
                <i data-lucide="presentation" class="w-20 h-20 mb-4"></i>
                <h2 class="text-2xl font-semibold">Your presentation will appear here</h2>
                <p class="text-lg mt-2">Enter a topic on the left and click "Generate".</e>
            </div>
            <!-- This is the template for a generated slide -->
            <div id="slide-content" class="hidden w-full h-full flex flex-col justify-center">
                <h2 id="slide-title" class="text-2xl sm:text-3xl lg:text-5xl font-bold text-gray-800 break-words"></h2>
                <ul id="slide-bullets" class="list-disc list-inside text-left text-lg sm:text-xl lg:text-3xl text-gray-700 space-y-3 sm:space-y-4 lg:space-y-6 mt-6 sm:mt-10 mx-auto max-w-prose">
                    <!-- Bullet points will be injected here -->
                </ul>
            </div>
        </div>

        <!-- Navigation Controls -->
        <div id="slide-nav" class="mt-6 flex justify-between items-center w-full max-w-5xl hidden">
            <button id="prev-btn" class="nav-btn bg-white p-3 rounded-full shadow-md hover:bg-gray-200 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                <i data-lucide="arrow-left" class="w-6 h-6 text-gray-700"></i>
            </button>
            <span id="slide-counter" class="text-lg font-medium text-gray-600"></span>
            <button id="next-btn" class="nav-btn bg-white p-3 rounded-full shadow-md hover:bg-gray-200 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                <i data-lucide="arrow-right" class="w-6 h-6 text-gray-700"></i>
            </button>
        </div>
    </div>

    <script>
        // --- State Management ---
        const state = {
            slides: [],
            currentSlide: 0,
            isLoading: false,
            errorMessage: '',
        };

        // --- DOM Elements ---
        const promptForm = document.getElementById('prompt-form');
        const topicInput = document.getElementById('topic');
        const slideCountInput = document.getElementById('slide-count');
        const docUpload = document.getElementById('doc-upload'); // NEW
        const generateBtn = document.getElementById('generate-btn');
        const btnText = document.getElementById('btn-text');
        const loadingSpinner = document.getElementById('loading-spinner');
        const errorMessageEl = document.getElementById('error-message');
        
        const slideViewer = document.getElementById('slide-viewer');
        const emptyState = document.getElementById('empty-state');
        const slideContent = document.getElementById('slide-content');
        const slideTitle = document.getElementById('slide-title');
        const slideBullets = document.getElementById('slide-bullets');
        
        const slideNav = document.getElementById('slide-nav');
        const prevBtn = document.getElementById('prev-btn');
        const nextBtn = document.getElementById('next-btn');
        const slideCounter = document.getElementById('slide-counter');

        // --- Gemini API Configuration ---
        const apiKey = ""; // API key is handled by the environment
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

        // Define the expected JSON structure for the AI response
        const responseSchema = {
            type: "ARRAY",
            items: {
                type: "OBJECT",
                properties: {
                    title: { type: "STRING" },
                    bullets: {
                        type: "ARRAY",
                        items: { type: "STRING" }
                    }
                },
                required: ["title", "bullets"]
            }
        };

        // --- Event Listeners ---
        promptForm.addEventListener('submit', handleGenerateClick);
        prevBtn.addEventListener('click', showPreviousSlide);
nextBtn.addEventListener('click', showNextSlide);
        docUpload.addEventListener('change', handleFileUpload); // NEW

        // --- NEW: File Upload Handler ---
        /**
         * Reads a text file and adds its content to the topic textarea.
         */
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) {
                return;
            }

            // Check for valid file types
            if (!file.type.startsWith('text/') && !file.name.endsWith('.md')) {
                setErrorMessage('Please upload a plain text file (.txt, .md).');
                event.target.value = null; // Clear the input
                return;
            }

            const reader = new FileReader();
            
            reader.onload = (e) => {
                const text = e.target.result;
                // Append text to the topic box, or set it if empty
                topicInput.value = topicInput.value 
                    ? topicInput.value + '\n\n--- Uploaded Content ---\n' + text 
                    : text;
                setErrorMessage(''); // Clear any previous errors
            };
            
            reader.onerror = () => {
                setErrorMessage('Failed to read the file.');
            };
            
            reader.readAsText(file);
            
            // Clear the input value to allow re-uploading the same file
            event.target.value = null;
        }

        // --- Core Functions ---

        /**
         * Handles the form submission to generate slides.
         */
        async function handleGenerateClick(e) {
            e.preventDefault();
            if (state.isLoading) return;

            const topic = topicInput.value;
            const slideCount = slideCountInput.value;

            if (!topic) {
                setErrorMessage('Please enter a topic.');
                return;
            }

            setLoading(true);
            setErrorMessage('');

            // Construct the prompt for the AI
            const systemPrompt = `You are a world-class presentation generation assistant.
Your task is to create a complete, informative, and engaging slide deck based on the user's topic.
The presentation must have exactly ${slideCount} slides.
For each slide, provide a concise title and a list of key bullet points.
If the user provides uploaded text, use it as the primary source material for the presentation.
Return the result as a JSON array, adhering to the provided schema.`;
            
            const userQuery = `Topic & Context: "${topic}"\nNumber of Slides: ${slideCount}`;
            
            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: responseSchema
                }
            };

            try {
                const result = await fetchWithBackoff(apiUrl, payload);
                if (!result.candidates || !result.candidates[0].content.parts[0].text) {
                    throw new Error('Invalid response from AI. Please try again.');
                }

                // Extract and parse the JSON response
                const jsonResponse = result.candidates[0].content.parts[0].text;
                state.slides = JSON.parse(jsonResponse);
                state.currentSlide = 0;
                
                renderSlide();

            } catch (error) {
                console.error('Error generating slides:', error);
                setErrorMessage(error.message || 'Failed to generate presentation. Please check your topic and try again.');
                // Show empty state if slides were not generated
                emptyState.classList.remove('hidden');
                slideContent.classList.add('hidden');
                slideNav.classList.add('hidden');
            } finally {
                setLoading(false);
            }
        }

        /**
         * Renders the current slide based on the state.
         */
        function renderSlide() {
            if (state.slides.length === 0) {
                emptyState.classList.remove('hidden');
                slideContent.classList.add('hidden');
                slideNav.classList.add('hidden');
                return;
            }

            // Hide empty state, show slide content
            emptyState.classList.add('hidden');
            slideContent.classList.remove('hidden');
            slideNav.classList.remove('hidden');

            const slide = state.slides[state.currentSlide];

            // Add a small fade transition
            slideContent.classList.add('opacity-0');
            
            setTimeout(() => {
                slideTitle.textContent = slide.title || 'Untitled Slide';
                
                // Clear old bullets
                slideBullets.innerHTML = ''; 
                
                // Add new bullets
                if (slide.bullets && slide.bullets.length > 0) {
                    slide.bullets.forEach(bullet => {
                        const li = document.createElement('li');
                        li.textContent = bullet;
                        slideBullets.appendChild(li);
                    });
                } else {
                    const li = document.createElement('li');
                    li.textContent = 'No content for this slide.';
                    li.className = 'text-gray-400 italic';
                    slideBullets.appendChild(li);
                }
                
                slideContent.classList.remove('opacity-0');
            }, 100); // Short delay for fade effect

            updateNav();
        }

        /**
         * Updates the navigation buttons and slide counter.
         */
        function updateNav() {
            slideCounter.textContent = `Slide ${state.currentSlide + 1} / ${state.slides.length}`;
            prevBtn.disabled = state.currentSlide === 0;
            nextBtn.disabled = state.currentSlide === state.slides.length - 1;
        }

        function showPreviousSlide() {
            if (state.currentSlide > 0) {
                state.currentSlide--;
                renderSlide();
            }
        }

        function showNextSlide() {
            if (state.currentSlide < state.slides.length - 1) {
                state.currentSlide++;
                renderSlide();
            }
        }

        // --- UI Helper Functions ---

        /**
         * Sets the loading state for the UI.
         * @param {boolean} isLoading
         */
        function setLoading(isLoading) {
            state.isLoading = isLoading;
            generateBtn.disabled = isLoading;
            if (isLoading) {
                btnText.textContent = 'Generating...';
                loadingSpinner.classList.remove('hidden');
            } else {
                btnText.textContent = 'Generate Presentation';
                loadingSpinner.classList.add('hidden');
            }
        }

        /**
         * Displays an error message to the user.
         * @param {string} message
         */
        function setErrorMessage(message) {
            state.errorMessage = message;
            if (message) {
                errorMessageEl.textContent = message;
                errorMessageEl.classList.remove('hidden');
            } else {
                errorMessageEl.classList.add('hidden');
            }
        }

        /**
         * A robust fetch wrapper with exponential backoff.
         */
        async function fetchWithBackoff(url, payload, retries = 5, delay = 1000) {
            for (let i = 0; i <= retries; i++) {
                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        return await response.json();
                    }
                    
                    if (response.status === 429 || response.status >= 500) {
                        // Retryable error
                        console.warn(`Attempt ${i + 1} failed with status ${response.status}. Retrying in ${delay}ms...`);
                        await new Promise(resolve => setTimeout(resolve, delay));
                        delay *= 2; // Exponential backoff
                    } else {
                        // Non-retryable error
                        const errorBody = await response.json();
                        throw new Error(errorBody.error?.message || `HTTP error! Status: ${response.status}`);
                    }
                } catch (error) {
                    if (i === retries) {
                        throw new Error(`Failed to fetch after ${retries} attempts: ${error.message}`);
                    }
                    if (error.name !== 'AbortError' && error.name !== 'TypeError') { // Don't retry client-side errors
                        await new Promise(resolve => setTimeout(resolve, delay));
                        delay *= 2;
                    } else {
                        throw error; // Re-throw client-side errors immediately
                    }
                }
            }
            throw new Error('Failed to get a response from the AI after all retries.');
        }

        // --- Initialization ---
        lucide.createIcons(); // Render all lucide icons
    </script>
</body>
</html>

